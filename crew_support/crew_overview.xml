<root>

    <windowclass name="partysheet_host" merge="join">
        <sheetdata>
            <sub_ps name="main_characters" insertbefore="tabs">
                <class>crew_overview_main</class>
                <fastinit/>
			    <activate />
            </sub_ps>
            <sub_ps name="supporting_characters" insertbefore="tabs">
                <class>crew_overview_support</class>
                <fastinit/>
			    <activate />
            </sub_ps>
            <sub_ps name="npc_characters" insertbefore="tabs">
                <class>crew_overview_npc</class>
                <fastinit/>
			    <activate />
            </sub_ps>
            <sub_ps name="crew_characters" insertbefore="tabs">
                <class>crew_overview_crew</class>
                <fastinit/>
			    <activate />
            </sub_ps>

			<tabs_partysheet name="tabs">
                <tab merge="add">
                    <icon>tab_players</icon>
                    <subwindow>main_characters</subwindow>
                </tab>
                <tab merge="add">
                    <icon>tab_support</icon>
                    <subwindow>supporting_characters</subwindow>
                </tab>
                <tab merge="add">
                    <icon>tab_npcs</icon>
                    <subwindow>npc_characters</subwindow>
                </tab>
                <tab merge="add">
                    <icon>tab_other</icon>
                    <subwindow>crew_characters</subwindow>
                </tab>
            </tabs_partysheet>
        </sheetdata>
    </windowclass>

    <template name="crew_support_list">
        <windowlist >
            <frame name="groupbox" offset="5,5,5,5"/>
            <anchored position="insidetop" >
                <bottom offset="-30"/>
            </anchored>
            <datasource>.charsheet</datasource>
            <class>crew_summary</class>
            <columns>
                <width>323</width>
                <fillwidth/>
            </columns>
            <script>
                function onInit()
                    setDatabaseNode(".charsheet")
                end
            </script>
        </windowlist>
    </template>

    <windowclass name="crew_overview_main">
        <sheetdata>
            <crew_support_list name="player_list">
                <script>
					function onFilter(crewEntry)
						return CrewSupportManager.crewState(crewEntry.getDatabaseNode()) == ""
					end
                </script>
            </crew_support_list>
        </sheetdata>
    </windowclass>


    <windowclass name="crew_overview_support">
        <sheetdata>
            <crew_support_list name="crew_list">
                <script>
					function onFilter(crewEntry)
						return CrewSupportManager.crewState(crewEntry.getDatabaseNode()) == "active"
					end
                </script>
            </crew_support_list>
        </sheetdata>
    </windowclass>


    <windowclass name="crew_overview_npc">
        <datasource merge="delete"/>
        <sheetdata>
            <crew_support_list name="crew_list">
                <script>
                    function onInit()
                        self.windows = {}
                    end
                    function remove(datasource)
                        self.windows[datasource].close()
                        self.windows[datasource] = nil
                    end
                    function onDrop(x, y, draginfo)
                        if draginfo.isType("shortcut") then
                            local class, datasource = draginfo.getShortcutData();
                            if ((class == "npc") or (class == "crewmate")) and (not self.windows[datasource]) then
                                self.windows[datasource] = createWindow(datasource)
                            end
                        end
                    end
                </script>
            </crew_support_list>
        </sheetdata>
    </windowclass>


    <windowclass name="crew_overview_crew">
        <datasource>.crewmate</datasource>
        <sheetdata>
            <crew_support_list name="crew_list">
                <script>
                    function onInit()
                        setDatabaseNode(".crewmate")
                    end
                </script>
            </crew_support_list>
        </sheetdata>
    </windowclass>

    <windowclass name="crew_summary_header">
        <script>
            function onInit()
                local parent = getDatabaseNode().getParent().getName()
                local state = CrewSupportManager.crewState(getDatabaseNode())
                local supportMode = not(state == "")
                local npcMode = (parent == "npc") or (parent == "npcs") or (parent == "crewmate")

                setControl(portrait, not npcMode)
                setControl(token, npcMode)
                setControl(deactivate, supportMode)
                setControl(clear, supportMode)
                setControl(remove_npc, npcMode)
                setControl(activate, npcMode or supportMode)
            end
            function setControl(control, state)
                control.setVisible(state)
                control.setEnabled(state)
            end
        </script>
        <sheetdata>
            <genericcontrol name="row_1">
                <anchored position="insidetopleft" height="20" width="0" />
            </genericcontrol>
			<genericcontrol>
                <anchored to="row_1" width="35" height="35">
                    <top />
                    <left anchor="right" relation="current" offset="5"/>
                </anchored>
				<icon>charlist_base</icon>
				<disabled />
			</genericcontrol>

			<portrait_char name="portrait">
                <anchored to="row_1" width="35" height="35">
                    <top />
                    <left anchor="right" relation="relative" offset="5"/>
                </anchored>
                <script>
                    function onDoubleClick(x, y)
                        Interface.openWindow("charsheet", window.getDatabaseNode())
                    end
                </script>
			</portrait_char>
			<tokenfield name="token">
                <anchored to="row_1" width="35" height="35">
                    <top />
                    <left anchor="right" relation="relative" offset="5"/>
                </anchored>
				<empty>token_empty</empty>
                <invisible/>
                <disabled/>
                <script>
                    function onDoubleClick(x, y)
                        Interface.openWindow("npc", window.getDatabaseNode())
                    end
                </script>
			</tokenfield>
			<char_header_label name="name">
                <anchored to="row_1" width="100"/>
				<labelres>char_label_name</labelres>
                <script>
                    function onInit()
                        super.onInit()
                        updateOwner()
                        DB.addHandler(window.getDatabaseNode().getNodeName(), "onChildUpdate", updateOwner)
                    end
                    function updateOwner()
                        local uName = DB.getOwner(window.getDatabaseNode())
                        if uName then
                            if labelwidget then
                                local w,h = labelwidget.getSize();
                                labelwidget.setPosition("bottomleft", w, h/2-4);
                            end
                            labelwidget.setText(uName)
                        end
                    end
                </script>
			</char_header_label>
            <buttoncontrol name="deactivate">
                <anchored to="row_1" width="20" height="20">
                    <left anchor="right" relation="relative" offset="2"/>
                    <top/>
                </anchored>
                <invisible />
                <disabled />
                <tooltip textres="tooltip_deactivate_support"/>
				<icon normal="button_clear" pressed="button_clear_down"/>
                <script>
                    function onButtonPress()
                        CrewSupportManager.releaseCrew(window.getDatabaseNode())
                    end
                </script>
            </buttoncontrol>
            <buttoncontrol name="clear">
                <anchored to="row_1" width="20" height="20">
                    <left anchor="right" relation="relative" offset="2"/>
                    <top/>
                </anchored>
                <invisible />
                <disabled />
                <tooltip textres="tooltip_clear_support_owner"/>
				<icon normal="button_effect" pressed="button_effect_down"/>
                <script>
                    function onButtonPress()
                        CrewSupportManager.releaseCrew(window.getDatabaseNode())
                        DB.setValue(window.getDatabaseNode(), "active", "number", 1)
                    end
                </script>
            </buttoncontrol>
            <buttoncontrol name="remove_npc">
                <anchored to="row_1" width="20" height="20">
                    <left anchor="right" relation="relative" offset="2"/>
                    <top/>
                </anchored>
                <invisible />
                <disabled />
                <tooltip textres="tooltip_remove_npc_from_overview"/>
				<icon normal="button_close" pressed="button_close_down"/>
                <script>
                    function onButtonPress()
                        window.parentcontrol.window.windowlist.remove(window.getDatabaseNode().getNodeName())
                    end
                </script>
            </buttoncontrol>
			<button_activateid name="activate">
                <anchored to="row_1" width="20" height="20">
                    <left anchor="right" relation="relative" offset="2"/>
                    <top/>
                </anchored>
                <invisible />
                <disabled />
            </button_activateid>
        </sheetdata>
    </windowclass>

    <windowclass name="crew_summary_main">
        <sheetdata>
            <genericcontrol name="col_1">
                <anchored position="insidetopleft" offset="5,0" height="0" width="0" />
            </genericcontrol>
            <genericcontrol name="col_2">
                <anchored position="insidetopleft" offset="100,0" height="0" width="0" />
            </genericcontrol>
            <genericcontrol name="col_2l">
                <anchored position="insidetopleft" offset="105,0" height="0" width="0" />
            </genericcontrol>
            <genericcontrol name="col_3">
                <anchored position="insidetopleft" offset="200,0" height="0" width="0" />
            </genericcontrol>
            <genericcontrol name="col_3l">
                <anchored position="insidetopleft" offset="205,0" height="0" width="0" />
            </genericcontrol>
            <genericcontrol name="col_4">
                <anchored position="insidetopleft" offset="300,0" height="0" width="0" />
            </genericcontrol>



            <overview_label>
                <static>Stress</static>
                <anchored to="col_1"/>
            </overview_label>
            <overview_num name="maxstress">
                <anchored to="col_2"/>
            </overview_num>
            <overview_num name="curstress">
                <anchored to="maxstress">
                    <right offset="-5"/>
                    <top merge="replace" relation="absolute"/>
                </anchored>
            </overview_num>

            <overview_label>
                <static>Resist:</static>
                <anchored to="col_2l"/>
            </overview_label>
            <overview_num name="resistance">
                <anchored to="col_3"/>
            </overview_num>
            <overview_label>
                <static>Deter:</static>
                <anchored to="col_3l"/>
            </overview_label>
            <overview_num name="curdetermination">
                <max>3</max>
                <anchored to="col_4"/>
            </overview_num>


            <overview_label>
                <static>Injured:</static>
                <anchored to="col_1"/>
            </overview_label>
            <overview_toggle name="injured">
                <anchored to="col_2"/>
            </overview_toggle>

            <overview_label>
                <static>Avoided:</static>
                <anchored to="col_2l"/>
            </overview_label>
            <overview_toggle name="avoided">
                <anchored to="col_3"/>
            </overview_toggle>

            <overview_label>
                <static>Ignored:</static>
                <anchored to="col_3l"/>
            </overview_label>
            <overview_toggle name="ignored">
                <anchored to="col_4"/>
            </overview_toggle>

            <overview_spacer>
                <anchored to="col_2"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_2l"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_3"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_3l"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_4"/>
            </overview_spacer>

			<overview_section_header >
                <anchored to="col_1">
                    <right parent="col_4"/>
                </anchored>
				<static>Milestones</static>
            </overview_section_header>

            <overview_label>
                <static>Scenes:</static>
                <anchored to="col_1"/>
            </overview_label>
            <overview_num name="milestone_scenes_present">
                <anchored to="col_2">
                    <top anchor="bottom" relation="relative"/>
                </anchored>
            </overview_num>

            <overview_label>
                <static>Val Used:</static>
                <anchored to="col_2l"/>
            </overview_label>
            <overview_toggle name="milestone_used_value">
                <anchored to="col_3"/>
            </overview_toggle>

            <overview_label>
                <static>Challenged:</static>
                <anchored to="col_3l"/>
            </overview_label>
            <overview_toggle name="milestone_challenge">
                <anchored to="col_4"/>
            </overview_toggle>

            <overview_label>
                <static>Injury:</static>
                <anchored to="col_3l"/>
            </overview_label>
            <overview_toggle name="milestone_injured">
                <anchored to="col_4"/>
            </overview_toggle>

            <overview_spacer>
                <anchored to="col_2"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_2l"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_3"/>
            </overview_spacer>
            <windowlist name="milestone_controls">
                <anchored to="col_1" height="20" >
                    <left />
                    <top anchor="bottom" offset="2" relation="relative"/>
                    <right parent="col_3"/>
                </anchored>
                <skipempty />
                <readonly />
                <columns>
                    <width>38</width>
                    <fillwidth />
                </columns>
                <script>
                    function onInit()
                        for _, name in ipairs(CrewSupportManager.IMPROVEMENT_SHORTNAMES) do
                            local w = createWindow()
                            w.type.setValue(name)
                        end
                    end
                </script>
                <class>milestone_button</class>
            </windowlist>



            <overview_spacer>
                <anchored to="col_2"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_2l"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_3"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_3l"/>
            </overview_spacer>
            <overview_spacer>
                <anchored to="col_4"/>
            </overview_spacer>

			<overview_section_header >
                <anchored to="col_1">
                    <right parent="col_4"/>
                </anchored>
				<static>Totals</static>
            </overview_section_header>

            <overview_label>
                <static>Normal MS:</static>
                <anchored to="col_1"/>
            </overview_label>
            <overview_num name="normal_milestones_total">
                <anchored to="col_2" />
            </overview_num>

            <overview_label>
                <static>Spotlight MS:</static>
                <anchored to="col_2l"/>
            </overview_label>
            <overview_num name="spotlight_milestones_total">
                <anchored to="col_3" />
            </overview_num>

            <overview_label>
                <static>Arc MS:</static>
                <anchored to="col_3l"/>
            </overview_label>
            <overview_num name="arc_milestones_total">
                <anchored to="col_4" />
            </overview_num>

			<overview_section_header >
                <anchored to="col_1">
                    <right parent="col_4"/>
                </anchored>
				<static>Values</static>
            </overview_section_header>

            <char_ref_list name="values">
                <datasource>.values</datasource>
                <frame merge="delete"/>
                <anchored merge="replace" to="col_1" height="100">
                    <top anchor="bottom" relation="relative" offset="2"/>
                    <left anchor="right" offset="2"/>
                    <right parent="col_4"/>
                </anchored>
            </char_ref_list>

			<overview_section_header >
                <anchored to="col_1">
                    <right parent="col_4"/>
                </anchored>
				<static>Directives</static>
            </overview_section_header>

            <char_ref_list name="directives">
                <datasource>.directives</datasource>
                <frame merge="delete"/>
                <anchored merge="replace" to="col_1">
                    <top anchor="bottom" relation="relative"/>
                    <left />
                    <right parent="col_4"/>
                    <bottom parent=""/>
                </anchored>
            </char_ref_list>
        </sheetdata>
    </windowclass>

    <windowclass name="crew_summary_abilities">
        <sheetdata>
            <genericcontrol name="topLeft">
                <anchored position="insidetopleft" offset="0, 0" />
            </genericcontrol>
            <genericcontrol name="topRight">
                <anchored position="insidetopright" offset="0, 0" />
            </genericcontrol>
            <genericcontrol name="middleRow">
                <anchored position="insidetopleft" offset="0, 315" />
            </genericcontrol>
            <scoreList name="attList">
                <anchored merge="replace" height="135">
                    <left parent="topLeft" offset="2" />
                    <right parent="" anchor="center" />
                    <top parent="topLeft" offset="10"/>
                </anchored>
                <script>
                    ---function basePage() return 100 end
                    function scores()
                        return ScopeManager.ALL_ATTRIBUTES
                    end
                    function scoreClass()
                        return "att_field"
                    end
                    function rollControl()
                        return window.activeAttribute
                    end
                </script>
            </scoreList>
            <scoreList name="discList">
                <anchored merge="replace"  height="135">
                    <left parent="" anchor="center" />
                    <right parent="topRight" offset="-2"/>
                    <top parent="topLeft" offset="10"/>
                </anchored>
                <script>
                    ---function basePage() return 106 end
                    function scores()
                        return ScopeManager.ALL_DISCIPLINES
                    end
                    function scoreClass()
                        return "disc_field"
                    end
                    function rollControl()
                        return window.activeDiscipline
                    end
                </script>
            </scoreList>
                            <!--      Roll Controls      -->
            <genericcontrol name="dieAnchor">
                <anchored to="attList" position="belowright" offset="-20,-15" height="20" width="40"/>
            </genericcontrol>
            <roll_dice_control name="rollTestControl">
                <anchored merge="replace" to="dieAnchor" position="insideleft" offset="2" height="20" width="18"/>
                <frame name="field_white_left" offset="1,0,1,0"/>
                <script>
                    function determinationUsed()
                        return nil
                    end
                </script>
            </roll_dice_control>
            <numbercontrol name="rollDC">
                <default>1</default>
                <min>0</min>
                <max>5</max>
                <anchored to="rollTestControl" width="16" height="20">
                    <bottom offset="0"/>
                    <left anchor="right" offset="0"/>
                </anchored>
                <frame name="field_white_right" />
            </numbercontrol>

            <numbercontrol name="activeAttribute">
                <anchored position="insidetopleft" height="0" width="0"/>
                <invisible />
                <script>
                    function setScore(name, value)
                        self.setValue(value)
                        window.activeAttributeName.setValue(name)
                    end
                </script>
            </numbercontrol>
            <active_score name="activeAttributeName">
                <anchored to="attList"/>
                <invisible/>
            </active_score>
            <numbercontrol name="activeDiscipline">
                <anchored position="insidetopleft" height="0" width="0"/>
                <invisible />
                <script>
                    function setScore(name, value)
                        self.setValue(value)
                        window.activeDisciplineName.setValue(name)
                    end
                </script>
            </numbercontrol>
            <active_score name="activeDisciplineName">
                <anchored to="discList"/>
                <invisible/>
            </active_score>

            <genericcontrol name="col_1">
                <anchored height="0" width="0" >
                    <top parent="attList" anchor="bottom" offset="5"/>
                    <left parent="" offset="5"/>
                </anchored>
            </genericcontrol>
            <genericcontrol name="col_4">
                <anchored height="0" width="0" >
                    <top parent="attList" anchor="bottom" offset="5"/>
                    <right parent="" offset="-5"/>
                </anchored>
            </genericcontrol>

<!--      Talents and Focuses      -->
            <overview_section_header >
                <anchored to="col_1">
                    <right parent="col_4"/>
                </anchored>
				<static>Focuses</static>
            </overview_section_header>

            <char_focus_list name="focuses">
                <datasource>.focuses</datasource>
                <frame merge="delete"/>
                <anchored merge="replace" to="col_1" height="100">
                    <top anchor="bottom" relation="relative" offset="2"/>
                    <left anchor="right" offset="2"/>
                    <right parent="col_4"/>
                </anchored>
            </char_focus_list>

			<overview_section_header >
                <anchored to="col_1">
                    <right parent="col_4"/>
                </anchored>
				<static>Talents</static>
            </overview_section_header>

            <char_linked_list name="talents">
                <datasource>.talents</datasource>
                <frame merge="delete"/>
                <anchored merge="replace" to="col_1">
                    <top anchor="bottom" relation="relative"/>
                    <left />
                    <right parent="col_4"/>
                    <bottom parent=""/>
                </anchored>
            </char_linked_list>

        </sheetdata>
    </windowclass>

    <windowclass name="crew_summary">
        <frame name="lcars_groupbox_dark" offset="2,3,2,3"/>
        <sheetdata>
            <genericcontrol name="sizeAnchor">
                <anchored position="insidetopleft" height="425" width="323"/>
            </genericcontrol>
            <subwindow name="header" >
                <anchored position="insidetop" height="40">
                    <left offset="5"/>
                    <right offset="-18" />
                    <top offset="5"/>
                </anchored>
                <class>crew_summary_header</class>
                <fastinit/>
			    <activate />
            </subwindow>
            <subwindow name="main">
                <anchored to="header" position="below">
                    <bottom parent="sizeAnchor"/>
                </anchored>
                <class>crew_summary_main</class>
                <fastinit/>
			    <activate />
            </subwindow>
            <subwindow name="abilities">
                <anchored to="header" position="below">
                    <bottom parent="sizeAnchor"/>
                </anchored>
                <class>crew_summary_abilities</class>
                <fastinit/>
            </subwindow>

            <buttongroup_tabs name="tabs">
                <anchored to="header" position="belowright" width="18" offset="-18,1"/>
                    <tab>
                        <icon>tab_main</icon>
                        <subwindow>main</subwindow>
                    </tab>
                    <tab>
                        <icon>tab_abilities</icon>
                        <subwindow>abilities</subwindow>
                    </tab>
            </buttongroup_tabs>
        </sheetdata>
    </windowclass>

    <windowclass name="rep_value_select">
        <frame name="recordsheet"/>
	  <placement>
		<size width="250" height="150" />
	  </placement>
        <sheetdata>
            <label name="label">
                <font>lcars_sheetlabel</font>
                <anchored position="insidetop" height="25" offset="-25,18"/>
            </label>
            <stringcontrol name="desc">
                <frame name="groupbox" offset="10,10,10,10"/>
                <anchored height="30">
                    <left offset="25"/>
                    <top offset="50" />
                    <right offset="-25"/>
                </anchored>
                <empty>Description...</empty>
            </stringcontrol>
            <genericcontrol name="blanchor">
                <anchored position="insidebottomleft" height="0" width="0" offset="20,35"/>
            </genericcontrol>
            <numbercontrol name="type">
                <anchored position="insidetopleft" height="0" width="0"/>
                <invisible />
            </numbercontrol>
            <label>
                <anchored to="blanchor">
                    <left anchor="right" offset="2" relation="relative" />
                    <top />
                </anchored>
                <static>Reputation </static>
            </label>
            <basicnumberc name="val">
                <anchored to="blanchor" width="20" height="20">
                    <left anchor="right" offset="5" relation="relative" />
                    <top />
                </anchored>
                <default>0</default>
            </basicnumberc>
            <buttoncontrol name="save">
                <anchored to="blanchor" width="45" height="20">
                    <left anchor="right" offset="5" relation="relative" />
                    <top />
                </anchored>
                <frame name="lcars_buttonup" offset="2,2,2,2" />
                <stateframe>
                    <pressed name="lcars_buttondown" offset="2,2,2,2" nobaseframe="true" />
                </stateframe>
                <state textres="lifepath_tooltip_save" />
                <script>
                    callback = nil
                    function setCallback(cb)
                        callback = cb
                    end
                    function onButtonPress()
                        if callback then callback(window.type.getValue(), window.val.getValue(), window.desc.getValue()) end
                        window.close()
                    end
                </script>
            </buttoncontrol>
        </sheetdata>
    </windowclass>

    <windowclass name="milestone_button">
        <sheetdata>
            <genericcontrol name="blanchor">
                <anchored position="insidetopleft" height="20"/>
            </genericcontrol>
            <label name="type">
                <anchored to="blanchor" height="20" width="10">
                    <left anchor="right" relation="relative" offset="2"/>
                    <top />
                </anchored>
                <static>Dick</static>
                <font>lcars_sheetlabelmini</font>
            </label>
            <buttoncontrol>
                <anchored to="blanchor" height="15" width="15">
                    <left anchor="right" relation="relative" />
                    <top offset="2"/>
                </anchored>
                <icon normal="button_add" pressed="button_add_down"/>
                <script file="crew_support/scripts/milestone_button.lua"/>
            </buttoncontrol>
        </sheetdata>
    </windowclass>

    <template name="overview_spacer">
        <genericcontrol>
            <anchored height="20">
                <left />
                <top anchor="bottom" relation="relative" offset="2"/>
            </anchored>
        </genericcontrol>
    </template>

    <template name="overview_section_header">
        <stringcontrol >
            <anchored height="20">
                <left anchor="right" offset="10"/>
                <right offset="-10"/>
                <top anchor="bottom" relation="relative" offset="2"/>
            </anchored>
            <lineoffset default="on">2</lineoffset>
            <static>Milestones</static>
            <font>lcars_sheettext</font>
        </stringcontrol>
    </template>

    <template name="overview_label">
        <label>
            <anchored height="20">
                <left anchor="right" offset="5"/>
                <top anchor="bottom" relation="relative" offset="2"/>
            </anchored>
            <font>lcars_sheetlabelmini</font>
        </label>
    </template>

    <template name="overview_toggle">
        <char_single_toggle_field>
            <anchored >
                <right anchor="left" offset="-5"/>
                <left merge="delete"/>
                <top anchor="bottom" relation="relative" offset="2"/>
            </anchored>
        </char_single_toggle_field>
    </template>

    <template name="overview_num">
        <basicnumber>
            <anchored height="20">
                <right anchor="left" offset="-10"/>
                <top anchor="bottom" relation="relative" offset="2"/>
            </anchored>
        </basicnumber>
    </template>
</root>